
input {
  beats {
    port => 5044
  }
}

filter {
  # Attempt to parse JSON messages into a `parsed` field. Non-JSON messages will be tagged
  # with _jsonparsefailure and left as raw `message` so they can still be indexed.
  json {
    source => "message"
    target => "parsed"
    tag_on_failure => ["_jsonparsefailure"]
  }

  # If JSON parsing failed, try structured parsing for common log formats using grok + kv
  if "_jsonparsefailure" in [tags] {
    # Apache/Nginx combined log format
    grok {
      match => { "message" => [ "%{COMBINEDAPACHELOG}", "%{COMMONAPACHELOG}" ] }
      add_tag => ["apache"]
      remove_field => ["message"]
    }

    # Typical application log: "2025-11-27 14:23:55,001 - ERROR - Service - message"
    if !("apache" in [tags]) {
      grok {
        match => { "message" => [ "%{TIMESTAMP_ISO8601:ts} - %{LOGLEVEL:log_level} - %{DATA:service} - %{GREEDYDATA:app_message}", "%{TIMESTAMP_ISO8601:ts} - %{LOGLEVEL:log_level} - %{DATA:service} - %{GREEDYDATA:app_message} - %{GREEDYDATA:extra}" ] }
        add_tag => ["app_log"]
      }
    }

    # Syslog / ssh / sudo style entries
    if !("apache" in [tags] and "app_log" in [tags]) {
      grok {
        match => { "message" => [ "%{SYSLOGTIMESTAMP:syslog_ts} %{HOSTNAME:syslog_host} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}", "%{SYSLOGTIMESTAMP:syslog_ts} %{GREEDYDATA:syslog_message}" ] }
        add_tag => ["syslog"]
      }
    }

    # Key/value style or audit entries (host=..., event=..., key=value).
    # Set target so we don't accidentally overwrite top-level ECS fields such as `host` (mapping conflicts).
    kv {
      source => "message"
      target => "kv_parsed"
      field_split => " "
      value_split => "="
      include_brackets => false
    }

    # For app logs that contain key=value at the end, parse kv pairs into fields
    if "app_log" in [tags] {
      kv {
        source => "app_message"
        target => "app_kv"
        field_split => " "
        value_split => "="
        include_brackets => false
        remove_field => ["app_message"]
      }
    }

    # Set event timestamp from parsed fields where possible
    if [ts] {
      date {
        match => ["ts", "ISO8601", "yyyy-MM-dd HH:mm:ss,SSS"]
        timezone => "UTC"
        target => "@timestamp"
      }
    }

  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "college-logs-%{+YYYY.MM.dd}"
  }
}
